<html>

<head>

<title>Log</title>

<link rel="stylesheet" href="include/swiftlogger.css">


<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type='module'>

    import {Log} from './modules/log.js';
    import {buildRow, formatPlaybackTime} from './modules/helper.js';
    import {EditableField} from './modules/editablefield.js';

    window.onload = setup;
    google.charts.load('current', {'packages':['corechart']});

    var id;

    function setup() {

        const params = new URLSearchParams(location.search);
        id = params.get('id');

        if (id) {
            loadLog(id);
        }
    
    }



async function loadLog(id) {
    // Load the log
    let log = await Log.fromId2(id);

    const date = `${log.startTime.getMonth()}/${log.startTime.getDate()}/${log.startTime.getFullYear()}`;
    
    // Update the page Titles
    document.title = `Swift Log ${date}`;
    document.getElementById('date').innerHTML = date;

    // Add the count
    document.getElementById('count').innerHTML = log.currentCount;

    // Setup notes and weather fields
    let notesField = new EditableField(
        id,
        'notes',
        document.getElementById('notes'),
        document.getElementById('editNotes'),
        log.notes,
        "No notes entered"
    )

    let weatherField = new EditableField(
        id,
        'weather',
        document.getElementById('weather'),
        document.getElementById('editWeather'),
        log.weather,
        "No weather information entered"
    )

    // document.getElementById('notes').innerHTML = log.notes ? log.notes : "No notes entered";
    // document.getElementById('weather').innerHTML = log.weather ? log.weather: "No weather information entered";

    // Update the edit log link
    let editLogLink = document.getElementById('editLog');
    if (log.logType == 'video') editLogLink.href = `videolog.html?id=${id}`;
    else {
        let parent = editLogLink.parentElement;
        parent.parentElement.removeChild(parent);
    }
    
    // Output the raw data
    let rawDataTable = document.getElementById('rawLog');
    log.data.forEach(entry => {
        rawDataTable.appendChild(buildRow([formatPlaybackTime(new Date(log.startTime.getTime() + entry.time)), entry.count]))
    })


    // Get the count by minute
    // let minuteCount = log.getCountByInterval(10);
    let minuteCount = log.getTotalByInterval(60);

    let chartData = minuteCount.map(entry => {
        return [entry.time, entry.count, entry.runningTotal];
    })

    drawChart(chartData)

    // Output the minute count
    const tbody = document.getElementById('log');

    minuteCount.forEach(minute => {
        tbody.appendChild(buildRow([formatPlaybackTime(minute.time), minute.count, minute.runningTotal]))
    })
    
}


function drawChart(tempData) {

    var data = new google.visualization.DataTable();
    data.addColumn('date', 'Time');
    data.addColumn('number', 'Count');
    data.addColumn('number', 'Running Total');

    data.addRows(tempData);

    var options = {
        title: 'Recorded Data',
        seriesType: 'bars',
        series: {
            0: {type: 'bar',
                targetAxisIndex: 0},
            1: {type: 'line',
                targetAxisIndex: 1}
        },
        vAxes: {
            0: {title: 'count'},
            1: {title: 'total'}
        }
    };

    var chart = new google.visualization.ComboChart(document.getElementById('dataChart'));

    chart.draw(data, options);
}

</script>

<body>

        <div class='header'>
                <div class='content'>
                <h2><a href='index.html'>Log-A-Swift</a></h2>
                <ul>
                    <li><a href='videolog.html'>New video log</a></li>
                    <li><a href='realtimelog.html'>New real time log</a></li>
                </ul>
            </div>
            </div>


            <div class='section titleBar'>
                <div class='content'>
                    <ul>
                        <li><h2 id='date'>Date</h2></li>
                        <li><h2><span id='count'></span> Birds</h2></li>
                        <li><a id='editLog'>Edit Log</a></li>
                    </ul>
                
                </div>
            </div>

<div class='content'>





<div class='info section'>
    <div>
        <div class='title'>
            <h3>Notes</h3><a href='#' id='editNotes'>Edit</a>
        </div>
        <p id='notes'></p>
    </div>

    <div>
        <div class='title'>
            <h3>Weather</h3><a href='#' id='editWeather'>Edit</a>
        </div>
        <p id='weather'></p>
    </div>
</div>




<div id="dataChart" class='chart section' style="width: 100%; height: 400px"></div>


<div class='section'>
<h3>Minute By Minute Data</h3>


<table>
    <thead>
        <tr>
            <th>Minute Starting</th>
            <th>Count</th>
            <th>Running Total</th>
        </tr>
    </thead>
    <tbody id='log'>

    </tbody>
</table>
</div>

<div class='section'>

<h3>Raw Data</h3>
<table>
    <thead>
        <tr>
            <th>Time Stamp</th>
            <th>Count</th>
        </tr>
    </thead>
    <tbody id='rawLog'>

    </tbody>
</table>


</div>


</body>