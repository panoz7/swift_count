<html>

<head>

<title>Log</title>

<style>

body {
    font-family: arial;
    background-color: #eee;
}

table {
    border-collapse: collapse;
}

table td, table th {
    border: 1px solid black;
    padding: 5px;
}


</style>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type='module'>

    import {Log} from './modules/log.js';
    import {buildRow, formatPlaybackTime} from './modules/helper.js';

    window.onload = setup;
    google.charts.load('current', {'packages':['corechart']});

    function setup() {

        const params = new URLSearchParams(location.search);
        const id = params.get('id');

        if (id) {
            loadLog(id);
        }
    

    }



async function loadLog(id) {
    // Load the log
    let log = await Log.fromId2(id);

    const date = `${log.startTime.getMonth()}/${log.startTime.getDate()}/${log.startTime.getFullYear()}`;
    
    // Update the page Titles
    document.title = `Swift Log ${date}`;
    document.getElementById('date').innerHTML = date;

    // Update the edit log link
    document.getElementById('editLog').href = `videolog.html?id=${id}`
    
    // Output the raw data
    let rawDataTable = document.getElementById('rawLog');
    log.data.forEach(entry => {
        rawDataTable.appendChild(buildRow([formatPlaybackTime(new Date(log.startTime.getTime() + entry.time)), entry.count]))
    })


    // Get the count by minute
    // let minuteCount = log.getCountByInterval(10);
    let minuteCount = log.getTotalByInterval(60);

    let chartData = minuteCount.map(entry => {
        return [entry.time, entry.count, entry.runningTotal];
    })

    drawChart(chartData)

    // Output the minute count
    const tbody = document.getElementById('log');

    minuteCount.forEach(minute => {
        tbody.appendChild(buildRow([formatPlaybackTime(minute.time), minute.count, minute.runningTotal]))
    })
    
}


function drawChart(tempData) {

    var data = new google.visualization.DataTable();
    data.addColumn('date', 'Time');
    data.addColumn('number', 'Count');
    data.addColumn('number', 'Running Total');

    data.addRows(tempData);

    var options = {
        title: 'Recorded Data',
        seriesType: 'bars',
        series: {
            0: {type: 'bar',
                targetAxisIndex: 0},
            1: {type: 'line',
                targetAxisIndex: 1}
        },
        vAxes: {
            0: {title: 'count'},
            1: {title: 'total'}
        }
    };

    var chart = new google.visualization.ComboChart(document.getElementById('dataChart'));

    chart.draw(data, options);
}





</script>

<body>

<h2><span id='date'></span> Log</h2>

<ul>
    <li>
        <a id='editLog'>Edit Log</a>
    </li>
</ul>

<div id="dataChart" style="width: 100%; height: 400px"></div>

<h2>Minute By Minute Data</h2>
<table>
    <thead>
        <tr>
            <th>Minute</th>
            <th>Count</th>
            <th>Running Total</th>
        </tr>
    </thead>
    <tbody id='log'>

    </tbody>
</table>

<h2>Raw Data</h2>
<table>
    <thead>
        <tr>
            <th>Time Stamp</th>
            <th>Count</th>
        </tr>
    </thead>
    <tbody id='rawLog'>

    </tbody>
</table>





</body>