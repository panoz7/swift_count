<html>

<head>
    <title>Realtime log</title>

<style>

    .hide {
        display: none;
    }

</style>

<script type='module'>

    import {LogCache} from './modules/logcache.js'
    import {OfflineLog} from './modules/log.js';

    // Global variables
    let logCache = new LogCache();
    let log; 

    window.onload = setup;

    function setup() {
        
        // Check to see if there's an in progress log that hasn't been saved
        if (localStorage.getItem('currentLog')) handleInProgressLog();

        document.getElementById('createNew').addEventListener('click', displayRecorder);

    }

    function handleInProgressLog() {

        showView('inProgressLog');

        // Create a new log from the localstorage data and save it to the global log variable;
        let logData = JSON.parse(localStorage.getItem('currentLog'))
        log = new OfflineLog(logData.startTime, logData.data);

        // Resume
        document.getElementById('resumeInProgress').addEventListener('click', displayRecorder);
        
        // Save
        document.getElementById('saveInProgress').addEventListener('click', saveLog);
        
        // Delete
        document.getElementById('deleteInProgress').addEventListener('click', () => {
            let remove = window.confirm("Are you sure you want to delete the log? This cannot be undone.")
            if (remove) {
                localStorage.removeItem('currentLog')
                showView('welcomeScreen');
            };
        })


    }

    function displayRecorder() {

        log = log ? log : new OfflineLog(new Date());

        showView('logRecorder');

        document.getElementById('currentTotal').innerHTML = log.currentCount;

        let addButtons = document.getElementsByClassName('addBird');
        for (let button of addButtons) {
            button.addEventListener('click', addBird)
        }

        document.getElementById('saveLog').addEventListener('click', saveLog);
    }

    function addBird(e) {
        // Add the birds to the log
        let num = Number(e.target.value);
        log.addData(num);

        // Display the new total
        document.getElementById('currentTotal').innerHTML = log.currentCount;
    }

    function saveLog() {
        // Add the log to the log cache and remove the temporary currentLog storage
        logCache.addLog(log);
        localStorage.removeItem('currentLog');

        // If we're online upload the log cache
        if (navigator.onLine) {
            logCache.addToDb()
            .then(() => {
                console.log("added to database")
            })
        }
        else {
            console.log("saved to local storage")
        }

    }


    function showView(id) {
        let views = document.getElementsByClassName('view');
        for (let view of views) {
            if (view.id == id) view.classList.remove('hide');
            else view.classList.add('hide');
        }
    }

    /*

    Stuff we need to handle: 
    - On launch check: 
        - Check to see if there are any inprogress logs
            -If so ask if they want to resume, save, or delete
        - Check to see if we have internet connectivity and if there are logs in the log cache
            - If so upload the log cache

    - 
        
    - Resuming an in progress log that wasn't saved
    - Saving an in progress log 
    - Delete an in progress log 

    - If we have internet connectivity and there are logs in the log cache upload them
    
    - Create new log
    
    - Buttons we need
        - Add 1, 2, 5, 10
        - Remove 1, 2, 5, 10
        - Undo last entry (pops the last item off the data array)
        - Save

    

    */

</script>


</head>

<body>

<div id='welcomeScreen' class='view'>
    <h2>Swift Log</h2>
    <input type='button' id='createNew' value='Create New Log'>
</div>

<div id='inProgressLog' class='view hide'>
    <p>There's an in progress log. What would you like to do with it?</p>
    <input type='button' id='resumeInProgress' value='Resume'>
    <input type='button' id='saveInProgress' value='Save'>
    <input type='button' id='deleteInProgress' value='Delete'>

</div>

<div id='logRecorder' class='view hide'>

    <input type='button' class='addBird' value='+1'>
    <input type='button' class='addBird' value='+2'>
    <input type='button' class='addBird' value='+5'>
    <input type='button' class='addBird' value='+10'>

    <input type='button' class='addBird' value='-1'>
    <input type='button' class='addBird' value='-2'>
    <input type='button' class='addBird' value='-5'>
    <input type='button' class='addBird' value='-10'>

    <div id='currentTotal'>a</div>

    <input type='button' id='saveLog' value='Done'>

</div>

</body>



</html>